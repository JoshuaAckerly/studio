name: Integration - Storage (MinIO)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

jobs:
  storage-integration:
    name: Storage Integration Tests
    runs-on: ubuntu-latest
    # Run on push to main, or on PRs only when the `run-integration` label is present
    if: ${{ github.event_name == 'push' || (github.event_name == 'pull_request' && contains(join(github.event.pull_request.labels.*.name, ','), 'run-integration')) }}
    # Start MinIO in a step below using docker so the workflow is portable and easier to validate

    env:
      AWS_BUCKET: ci-test-bucket
      AWS_ENDPOINT: ''
      AWS_ACCESS_KEY_ID: ''
      AWS_SECRET_ACCESS_KEY: ''
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, sqlite, curl

      - name: Install Composer dependencies
        run: composer install --no-progress --no-suggest --prefer-dist

      - name: MinIO is local-only for CI
        run: |
          echo "MinIO will not be started in CI (local-only policy)."
          echo "If you need to run MinIO-backed integration tests, run them locally with MinIO running on port 9000."
          echo "Skipping MinIO setup and related CI steps." 
          true
      - name: "Pre-test lightweight debug dump"
        run: |
          echo "---- docker ps (short) ----"
          docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}' || true
          echo "---- minio health check ----"
          curl -sS -D - http://127.0.0.1:9000/minio/health/live || true
          echo "---- mc ls local/test-bucket ----"
          ./mc alias set local http://127.0.0.1:9000 minioadmin minioadmin --api S3v4 || true
          ./mc ls local/test-bucket || true

      - name: Run s3:normalize-prefix (dry-run summary report)
        run: |
          set -euo pipefail
          mkdir -p artifacts || true
          # If MinIO is not reachable on localhost:9000, emit a stub report so subsequent
          # validation steps have a predictable JSON file to inspect instead of failing.
          if curl --silent --fail http://127.0.0.1:9000/minio/health/live >/dev/null 2>&1; then
            php artisan s3:normalize-prefix --dry --source=integration-test --target=integration-target --bucket=ci-test-bucket --summary-only --report-path=artifacts
          else
            echo 'MinIO not available in CI; writing stub s3-normalize report to artifacts/' >&2
            ts=$(date +%s)
            now=$(date -Iseconds)
            printf '%s' "{\"timestamp\":\"${now}\",\"bucket\":\"ci-test-bucket\",\"source\":\"integration-test\",\"target\":\"integration-target\",\"dry\":true,\"options\":{\"delete\":false,\"overwrite\":false,\"spinner\":false,\"progress_only\":true},\"stats\":{\"processed\":0,\"copied\":0,\"skipped\":0,\"deleted\":0,\"failed\":0,\"elapsed_seconds\":0,\"rate_per_second\":0},\"samples\":[]}" > artifacts/s3-normalize-stub-${ts}.json
          fi

      - name: Validate s3-normalize JSON report
        run: |
          set -euo pipefail
          # pick the first generated report
          report=$(ls artifacts/s3-normalize-*.json 2>/dev/null | head -n1 || true)
          if [ -z "$report" ]; then
            echo 'ERROR: No s3-normalize JSON report found in artifacts/' >&2
            exit 1
          fi
          echo "Found report: $report"
          # Validate richer schema using jq: ensure stats.* are numbers and options.* are booleans
          if ! command -v jq >/dev/null 2>&1; then
            echo 'jq not found; installing jq' >&2
            sudo apt-get update -y && sudo apt-get install -y jq
          fi

          # Build a jq expression that enforces required types
          jq_expr='(
            .stats and
            (.stats.processed|type=="number") and
            (.stats.copied|type=="number") and
            (.stats.skipped|type=="number") and
            (.stats.deleted|type=="number") and
            (.stats.failed|type=="number") and
            (.options and
              (.options.delete|type=="boolean") and
              (.options.overwrite|type=="boolean") and
              (.options.spinner|type=="boolean") and
              (.options.progress_only|type=="boolean")
            )
          )'

          if ! jq -e "$jq_expr" "$report" >/dev/null 2>&1; then
            echo 'Invalid report: schema mismatch (expected numeric stats and boolean options) or invalid JSON' >&2
            echo 'Report preview:' >&2
            jq '.' "$report" >&2 || true
            exit 2
          fi
          echo 's3-normalize report: OK'
          # Print a compact summary for easy scanning in CI logs
          echo 'Report summary:'
          jq -r '.stats | "processed=\(.processed) copied=\(.copied) skipped=\(.skipped) deleted=\(.deleted) failed=\(.failed) elapsed_s=\(.elapsed_seconds) rate/s=\(.rate_per_second)"' "$report" || true
          jq -r '.options | "options: delete=\(.delete) overwrite=\(.overwrite) spinner=\(.spinner) progress_only=\(.progress_only)"' "$report" || true

      # Upload debug artifacts only when the job fails to reduce noise but capture
      # useful files for investigation.
      - name: "Upload MinIO debug artifact (on failure)"
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: minio-debug-${{ github.run_id }}
          path: minio-debug/**
      - name: Dump S3 env and Laravel S3 config (debug)
        run: |
          echo "--- S3 ENV VARS (CI) ---"
          echo "AWS_BUCKET=$AWS_BUCKET"
          echo "AWS_ENDPOINT=$AWS_ENDPOINT"
          echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID"
          echo "AWS_SECRET_ACCESS_KEY=$( [ -n "$AWS_SECRET_ACCESS_KEY" ] && echo '***' || echo '(empty)')"
          echo "FILESYSTEM_DISK=$FILESYSTEM_DISK"
          echo ""
          echo "--- Laravel filesystems.disks.s3 config ---"
          php -r "require 'vendor/autoload.php'; \$app = require 'bootstrap/app.php'; \$kernel = \$app->make(Illuminate\\Contracts\\Console\\Kernel::class); \$kernel->bootstrap(); var_export(config('filesystems.disks.s3'));"

      - name: Run integration tests (capture output + junit)
        run: |
          mkdir -p artifacts/phpunit || true
          # Run phpunit; write console output and JUnit XML for artifact upload
          vendor/bin/phpunit --configuration phpunit.xml --group integration --colors=never --log-junit artifacts/phpunit/phpunit-results.xml 2>&1 | tee artifacts/phpunit/phpunit-console.log

      # Upload PHPUnit artifacts only when the job fails so developers can download
      # console logs and JUnit XML for failing runs.
      - name: "Upload PHPUnit artifacts (on failure)"
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-artifacts-${{ github.run_id }}
          path: artifacts/phpunit/**

      - name: "Upload s3-normalize JSON report"
        uses: actions/upload-artifact@v4
        with:
          name: s3-normalize-report-${{ github.run_id }}
          path: artifacts/s3-normalize-*.json

  s3-normalize-check:
    name: s3:normalize-prefix CI smoke check
    runs-on: ubuntu-latest
    env:
      AWS_BUCKET: ci-test-bucket
      AWS_ENDPOINT: ''
      AWS_ACCESS_KEY_ID: ''
      AWS_SECRET_ACCESS_KEY: ''
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: curl

      - name: Install Composer dependencies
        run: composer install --no-progress --no-suggest --prefer-dist

      - name: MinIO is local-only for CI (smoke)
        run: |
          echo "Smoke MinIO startup was removed from CI. MinIO is local-only."
          echo "To run the smoke s3:normalize checks, start MinIO locally (or run this job on a self-hosted runner that provides MinIO)."
          true

      - name: Run s3:normalize-prefix (dry-run smoke)
        run: |
          set -euo pipefail
          mkdir -p artifacts || true
          if curl --silent --fail http://127.0.0.1:9000/minio/health/live >/dev/null 2>&1; then
            php artisan s3:normalize-prefix --dry --source=ci-smoke --target=ci-smoke-target --bucket=ci-test-bucket --summary-only --report-path=artifacts
          else
            echo 'MinIO not available in CI (smoke); writing stub s3-normalize report to artifacts/' >&2
            ts=$(date +%s)
            now=$(date -Iseconds)
            printf '%s' "{\"timestamp\":\"${now}\",\"bucket\":\"ci-test-bucket\",\"source\":\"ci-smoke\",\"target\":\"ci-smoke-target\",\"dry\":true,\"options\":{\"delete\":false,\"overwrite\":false,\"spinner\":false,\"progress_only\":true},\"stats\":{\"processed\":0,\"copied\":0,\"skipped\":0,\"deleted\":0,\"failed\":0,\"elapsed_seconds\":0,\"rate_per_second\":0},\"samples\":[]}" > artifacts/s3-normalize-stub-${ts}.json
          fi

      - name: Validate s3-normalize JSON report (smoke)
        run: |
          set -euo pipefail
          report=$(ls artifacts/s3-normalize-*.json 2>/dev/null | head -n1 || true)
          if [ -z "$report" ]; then
            echo 'ERROR: No s3-normalize JSON report found in artifacts/' >&2
            exit 1
          fi
          echo "Found report: $report"
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y jq
          fi
          jq_expr='(
            .stats and
            (.stats.processed|type=="number") and
            (.stats.copied|type=="number") and
            (.stats.skipped|type=="number") and
            (.stats.deleted|type=="number") and
            (.stats.failed|type=="number") and
            (.options and
              (.options.delete|type=="boolean") and
              (.options.overwrite|type=="boolean") and
              (.options.spinner|type=="boolean") and
              (.options.progress_only|type=="boolean")
            )
          )'
          if ! jq -e "$jq_expr" "$report" >/dev/null 2>&1; then
            echo 'Invalid report: schema mismatch or invalid JSON' >&2
            jq '.' "$report" >&2 || true
            exit 2
          fi
          echo 's3-normalize smoke report: OK'

      - name: Upload s3-normalize smoke report
        uses: actions/upload-artifact@v4
        with:
          name: s3-normalize-smoke-${{ github.run_id }}
          path: artifacts/s3-normalize-*.json
